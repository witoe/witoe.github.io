<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <title>IGUU</title><meta name="description" content="MY personal blog.">
    <link rel="preload" href="/assets/js/runtime~app.e9b55bcc.js" as="script"><link rel="preload" href="/assets/css/styles.7264dd61.css" as="style"><link rel="preload" href="/assets/js/1812.2c59b7ed.js" as="script"><link rel="preload" href="/assets/js/app.cdc4364a.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.7264dd61.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">IGUU</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Teaching"><span class="title">Teaching</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Teaching"><span class="title">Teaching</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/teaching/web211/" class="nav-link" aria-label="web211"><!--[--><!--]--> web211 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://orcid.org/0000-0003-1706-525X" rel="noopener noreferrer" target="_blank" aria-label="ORCID"><!--[--><!--]--> ORCID <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/iguyong/iguyong.github.io" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Teaching"><span class="title">Teaching</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Teaching"><span class="title">Teaching</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/teaching/web211/" class="nav-link" aria-label="web211"><!--[--><!--]--> web211 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://orcid.org/0000-0003-1706-525X" rel="noopener noreferrer" target="_blank" aria-label="ORCID"><!--[--><!--]--> ORCID <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/iguyong/iguyong.github.io" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="future" tabindex="-1"><a class="header-anchor" href="#future" aria-hidden="true">#</a> Future</h2><p>python 中的 Future 相当于 js 中的 Promise ，功能是把”事件发生“ 与”回调函数“ 分离。不仅可以先注册callback, 等“事件发生”（Future中是set_result, js中是resolve)后自动调用一个或多个callback; 还可以在 set_result后在注册callback. 内部通过保存”事件发生“这一状态来实现 Deferred 效果。</p><h2 id="select" tabindex="-1"><a class="header-anchor" href="#select" aria-hidden="true">#</a> Select</h2><p>python中的select module中有针对不同平台的系统函数来完成IO复用的功能，最原始的是select函数, 在大多数平台上都有。poll比 select更优化一些，本质上差不多。只存在于linux上的epoll 以及 BSD 上的 kqueue，windows上的IOCP, Solaris上的devpoll 则更加优化和强大。其中IOCP是真正的异步，不存在阻塞，其它或多或少有一点阻塞，epoll和kqueue在性能上基本上更真正的异步差不多，devpoll不太清楚。</p><p>这些类select函数根据平台的不同，有的只支持sockets（IOCP), 有的还支持pipe( epoll ) 或其它file-like objects. 有的只能监听到readable/writable/error, 有的能精确区分更复杂的事件。epoll 有水平（level）触发和边沿（edge)触发。</p><p>python中的selectors module (相当于nodejs中隐含在内部的libuv库） 则将这些不同的select函数抽象成一个统一的接口，用户只需要用DefaultSelector 来获得当前平台下最适合的select。这些类select主要实现以下功能</p><p>register(fileobj, events, data=Non): 注册fileobj 以及需要监听的事件</p><p>unregister(fileobj): 注销</p><p>modify(fileobj, events, data=Non): 更改</p><p>select(timeout=None): 返回有”事件发生“的(key, events) list, 其中的key 为SectorKey类，包含fileobj, fd, events, data。该方法会根据timeout的值进行阻塞或非阻塞调用。其内部原理比较复杂，大致是结合了中断和轮询来实现的。</p><p><a href="https://blog.csdn.net/hdutigerkin/article/details/7517390" target="_blank" rel="noopener noreferrer">epoll详细工作原理<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><h2 id="asyncio" tabindex="-1"><a class="header-anchor" href="#asyncio" aria-hidden="true">#</a> asyncio</h2><p>有了python的callback机制，以及select module, 我们已经可以手写地实现python中的异步功能。但是，这样写会很麻烦，代码不易读。于是就有了各种第三方库来简化，如 Tornado, Twisted, Gevent, Eventlet, greenlet等。从3.4开始, python引入了标准库 asyncio.</p><p>greenlet （比较低级，一般用来构建其它库） Eventlet (基于IO复用和coroutine, 相当于implictly调用coroutine, 不需要像coroutine那样explictly切换控制流) Gevent (与Eventlet类似，但功能更强大） Twisted（面向对象，基于事件驱动的网络库，比较低级） Tornado (作为一个web框架和异步网络库使用，同样基于IO复用和coroutine） async实现了许多功能，要理解它的话需要理解以下几个关键的东西：coroutine, Task, event_loop</p><h2 id="coroutine" tabindex="-1"><a class="header-anchor" href="#coroutine" aria-hidden="true">#</a> Coroutine</h2><p>coroutine是通过将Future与generator结合实现的, 其核心在于：</p><p>通过yield一个Future将该运行中的coroutine控制流”挂起“ ，相当于thread中的sleep。然而这里是通过generator的机制来保存其运行中间状态，而不是thread中的context switch. 这样不仅比thread节省时间和空间资源，还能减少绝大多数的data race. 因为这里的控制流只在yield处才会被挂起，而thread的挂起是由内核决定的，可发生的任意时候（除非加锁，disable中断）。因些coroutne某种意义上可看作green thread(轻量级线程） 在需要的时候（例如Task中），通过send将某个coroutine唤醒 coroutine 的好处在于可以将异步流用同步的方式来写。</p><h2 id="task" tabindex="-1"><a class="header-anchor" href="#task" aria-hidden="true">#</a> Task</h2><p>以下是Task的一个简化版</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Task</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> coro<span class="token punctuation">)</span><span class="token punctuation">:</span>
  self<span class="token punctuation">.</span>coro <span class="token operator">=</span> coro
  f <span class="token operator">=</span> Future<span class="token punctuation">(</span><span class="token punctuation">)</span>
  f<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>step<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

  <span class="token keyword">def</span> <span class="token function">step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">try</span><span class="token punctuation">:</span>
  next_future <span class="token operator">=</span> self<span class="token punctuation">.</span>coro<span class="token punctuation">.</span>send<span class="token punctuation">(</span>future<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
  <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>
  <span class="token keyword">return</span>

  next_future<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>self<span class="token punctuation">.</span>step<span class="token punctuation">)</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>每构造一个Task, 其中的coroutine就会执行，一直到yield处”挂起“，并返回一个Future。等到Future被set_result后，该coroutine又会被”唤醒“。其中Future的set_result是由select来完成的。</p><h2 id="event-loop" tabindex="-1"><a class="header-anchor" href="#event-loop" aria-hidden="true">#</a> Event_loop</h2><p>run_until_complete函数接收一个或多个Task对象（若是Future的话，会自动包装生成Task)，直至所有的Task返回。这些Task的”用户代码“ 可以看作是运行在单线程中，而IO操作是通过select功能得到复用。</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">EventLoop</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">run_until_complete</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> coro<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Run until the coroutine is done.&quot;&quot;&quot;</span>
        task <span class="token operator">=</span> Task<span class="token punctuation">(</span>coro<span class="token punctuation">)</span>
        task<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>stop_callback<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> StopError<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>

<span class="token keyword">class</span> <span class="token class-name">StopError</span><span class="token punctuation">(</span>BaseException<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Raised to stop the event loop.&quot;&quot;&quot;</span>

<span class="token keyword">def</span> <span class="token function">stop_callback</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">raise</span> StopError
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>有了coroutine, Task, Event_loop 后，我们还需要自己写select的注册/注销/返回事件 等操作，register写在yield前，unregister写在yield后。但是一些支持异步的库会自动实现这两步，不需要手动来写。例如aiohttp.</p><p>selector.select()函数的调用也不需要手写，个人猜测是event_loop自动开了这样一个coroutine (或thread)运行。</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    events <span class="token operator">=</span> selector<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> event_key<span class="token punctuation">,</span> event_mask <span class="token keyword">in</span> events<span class="token punctuation">:</span>
        callback <span class="token operator">=</span> event_key<span class="token punctuation">.</span>data
        callback<span class="token punctuation">(</span>event_key<span class="token punctuation">,</span> event_mask<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/iguyong/iguyong.github.io/edit/main/docs/python/python-async.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">11/24/2021, 8:54:40 AM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: jcel@qq.com">guyong</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.e9b55bcc.js" defer></script><script src="/assets/js/1812.2c59b7ed.js" defer></script><script src="/assets/js/app.cdc4364a.js" defer></script>
  </body>
</html>
